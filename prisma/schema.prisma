// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id          Int       @id @default(autoincrement())
  userNumber  Int       @unique
  email       String    @unique
  phone       String    @unique
  name        String
  avatar      String?
  status	    String?
  team	      String?
  position	  Int?      @default(0)
  duties	    Int?      @default(0)// 0b00000000
  createdAt	  DateTime  @default(now())
  updatedAt	  DateTime  @updatedAt
  presentedSeminars	Seminar[]  @relation(name:"presentedSeminar")
  writtenReviews	  Review[]   @relation(name:"writtenReview")

  requests          Request[]

  tokens	          Token[]
  // writtenReviews Review[]
  // receivedReviews Review[]
}

model Token {
  id          Int       @id @default(autoincrement())
  payload     String    @unique
  
  user        User      @relation(fields:[userId], references:[id], onDelete: Cascade)
  userId      Int
  @@index([userId])

  createdAt	  DateTime  @default(now())
  updatedAt	  DateTime  @updatedAt
}

model Semester{
  id Int @id @default(autoincrement())
  year Int
  season Int

  postDocCount  Int
  partTimeCount Int
  fullTimeCount Int

  seminars      Seminar[]
  seminarSlots  Seminarslot[]

  settings      Settings[]
}

model Seminar {
  id            Int       @id @default(autoincrement())
  alias         String    @unique //2022-F-34141-[01~99]
  createdAt	    DateTime  @default(now())
  updatedAt	    DateTime  @updatedAt

  semester      Semester  @relation(fields:[semesterId], references:[id], onDelete: Cascade)
  semesterId    Int
  @@index([semesterId])

  presentedBy   User      @relation(name:"presentedSeminar", fields:[presentedById], references:[id], onDelete: Cascade)
  presentedById Int
  @@index([presentedById])

  // Many-to-Many NOT SUPPORTED IN MYSQL. Bypassing through Review model
  // reviewedBy User[] @relation(name:"reviewedSeminar", fields:[reviewedById], references:[id], onDelete: Cascade)
  // reviewedById Int
  // @@index([reviewedById])

  title         String
  abstract      String  @db.Text
  category      String
  tags          String  //(TODO: Array.)
  progress      Int     //(Enum. No submission, Draft submission, Reviewed, Full submission)
  draftFile     String
  finalFile     String

  slot          Seminarslot?

  reviews Review[]
}

model Seminarslot{
  id            Int @id @default(autoincrement())

  dateTime	    DateTime  

  semester Semester @relation(fields:[semesterId], references:[id], onDelete: Cascade)
  semesterId Int
  @@index([semesterId])

  seminar Seminar? @relation(fields:[seminarId], references:[id])
  seminarId Int? @unique
  @@index([seminarId])
}

model Review{
  id          Int       @id @default(autoincrement())
  createdAt	  DateTime  @default(now())
  updatedAt	  DateTime  @updatedAt

  reviewFor   Seminar   @relation(fields:[seminarId], references:[id], onDelete: Cascade)
  seminarId   Int
  @@index([seminarId])
 
  review      String

  writtenBy   User      @relation(name:"writtenReview", fields:[writtenById], references:[id], onDelete:Cascade)
  writtenById Int
  @@index([writtenById])
}


model Request{
  id          Int       @id @default(autoincrement())
  createdAt	  DateTime  @default(now())
  updatedAt	  DateTime  @updatedAt

  requestedBy User      @relation(fields:[userId], references:[id], onDelete: Cascade)
  userId      Int
  @@index([userId])

  kind        Int //(Enum. announcement, carry-out, credit-card, purchase, business-trip, review)
  payload     Int //id of requesting item. (e.g. seminar id)

  due         DateTime
  status      Int //(Enum. Pending, Accepted(Processing), Delayed, Rejected)
  // 세미나 관련 request 및 status는 모두 유지
  // 나머지의 경우 처리 완료되면 레코드 삭제.
}

model Settings{
  id          Int       @id @default(autoincrement())

  currentSemester Semester  @relation(fields:[currentSemesterId], references:[id], onDelete: Cascade)
  currentSemesterId    Int
  @@index([currentSemesterId])
  
}